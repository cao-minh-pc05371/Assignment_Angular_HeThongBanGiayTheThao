<div class="checkout-container">
    <!-- Loading spinner -->
    <div *ngIf="isLoading" class="loading-spinner">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Đang tải dữ liệu...</p>
    </div>

    <div class="checkout-content" *ngIf="!isLoading">
        <div class="checkout-header">
            <h1>Thanh toán</h1>
            <p>Vui lòng điền thông tin giao hàng và lựa chọn phương thức thanh toán</p>
        </div>

        <div class="checkout-main">
            <!-- Thông tin đơn hàng -->
            <div class="checkout-column order-summary">
                <mat-card>
                    <mat-card-header>
                        <mat-card-title>Thông tin đơn hàng</mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <div class="order-items">
                            <div class="order-item" *ngFor="let item of cartItems">
                                <div class="item-image">
                                    <img [src]="item.product_variant?.product?.image || 'assets/images/no-image.png'"
                                        [alt]="item.product_variant?.product?.name">
                                </div>
                                <div class="item-details">
                                    <h3>{{ item.product_variant?.product?.name }}</h3>
                                    <p *ngIf="item.product_variant?.size">Size: {{ item.product_variant?.size?.name }}
                                    </p>
                                    <p *ngIf="item.product_variant?.color">Màu: {{
                                        item.product_variant?.color?.color_name }}
                                    </p>
                                    <p>{{ item.product_variant?.product?.price | currency:'VND':'symbol':'1.0-0' }} x {{
                                        item.quantity }}</p>
                                </div>
                                <div class="item-price">
                                    {{ (item.product_variant?.product?.price || 0) * item.quantity |
                                    currency:'VND':'symbol':'1.0-0' }}
                                </div>
                            </div>
                        </div>

                        <mat-divider></mat-divider>

                        <div class="order-totals">
                            <div class="total-row">
                                <span>Tạm tính:</span>
                                <span>{{ getTotalPrice() | currency:'VND':'symbol':'1.0-0' }}</span>
                            </div>
                            <div class="total-row">
                                <span>Phí vận chuyển:</span>
                                <span>{{ 0 | currency:'VND':'symbol':'1.0-0' }}</span>
                            </div>
                            <div class="total-row grand-total">
                                <span>Tổng cộng:</span>
                                <span>{{ getTotalPrice() | currency:'VND':'symbol':'1.0-0' }}</span>
                            </div>
                        </div>
                    </mat-card-content>
                </mat-card>
            </div>

            <!-- Form thanh toán -->
            <div class="checkout-column checkout-form">
                <mat-card>
                    <mat-card-content>
                        <form [formGroup]="checkoutForm" (ngSubmit)="placeOrder()">
                            <h2>Thông tin giao hàng</h2>

                            <!-- Họ tên -->
                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Họ và tên</mat-label>
                                <input matInput formControlName="fullName" placeholder="Nguyễn Văn A">
                                <mat-error *ngIf="f['fullName'].hasError('required')">
                                    Vui lòng nhập họ tên
                                </mat-error>
                                <mat-error *ngIf="f['fullName'].hasError('minlength')">
                                    Họ tên phải có ít nhất 3 ký tự
                                </mat-error>
                            </mat-form-field>

                            <!-- Email và Số điện thoại -->
                            <div class="form-row">
                                <mat-form-field appearance="outline">
                                    <mat-label>Email</mat-label>
                                    <input matInput formControlName="email" placeholder="example@email.com">
                                    <mat-error *ngIf="f['email'].hasError('required')">
                                        Vui lòng nhập email
                                    </mat-error>
                                    <mat-error *ngIf="f['email'].hasError('email')">
                                        Email không hợp lệ
                                    </mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>Số điện thoại</mat-label>
                                    <input matInput formControlName="phone" placeholder="0123456789">
                                    <mat-error *ngIf="f['phone'].hasError('required')">
                                        Vui lòng nhập số điện thoại
                                    </mat-error>
                                    <mat-error *ngIf="f['phone'].hasError('pattern')">
                                        Số điện thoại phải có 10 chữ số
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <!-- Địa chỉ -->
                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Địa chỉ</mat-label>
                                <input matInput formControlName="address" placeholder="Số nhà, tên đường">
                                <mat-error *ngIf="f['address'].hasError('required')">
                                    Vui lòng nhập địa chỉ
                                </mat-error>
                            </mat-form-field>

                            <!-- Tỉnh/Thành phố, Quận/Huyện, Phường/Xã -->
                            <div class="form-row">
                                <mat-form-field appearance="outline">
                                    <mat-label>Tỉnh/Thành phố</mat-label>
                                    <mat-select formControlName="city">
                                        <mat-option *ngFor="let city of cities" [value]="city">
                                            {{ city }}
                                        </mat-option>
                                    </mat-select>
                                    <mat-error *ngIf="f['city'].hasError('required')">
                                        Vui lòng chọn tỉnh/thành phố
                                    </mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>Quận/Huyện</mat-label>
                                    <input matInput formControlName="district">
                                    <mat-error *ngIf="f['district'].hasError('required')">
                                        Vui lòng nhập quận/huyện
                                    </mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>Phường/Xã</mat-label>
                                    <input matInput formControlName="ward">
                                    <mat-error *ngIf="f['ward'].hasError('required')">
                                        Vui lòng nhập phường/xã
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <h2>Phương thức thanh toán</h2>
                            <div class="payment-methods">
                                <mat-radio-group formControlName="paymentMethod" class="payment-radio-group">
                                    <mat-radio-button *ngFor="let method of paymentMethods" [value]="method.value"
                                        class="payment-radio-button">
                                        <div class="payment-method-content">
                                            <mat-icon>{{ method.icon }}</mat-icon>
                                            <span>{{ method.label }}</span>
                                        </div>
                                    </mat-radio-button>
                                </mat-radio-group>
                            </div>

                            <!-- Ghi chú -->
                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Ghi chú</mat-label>
                                <textarea matInput formControlName="notes" rows="3"
                                    placeholder="Ghi chú về đơn hàng, ví dụ: thời gian hay địa điểm giao hàng chi tiết hơn"></textarea>
                            </mat-form-field>

                            <!-- Button đặt hàng -->
                            <div class="checkout-actions">
                                <button type="button" mat-stroked-button color="primary" routerLink="/cart">
                                    <mat-icon>arrow_back</mat-icon> Quay lại giỏ hàng
                                </button>
                                <button type="submit" mat-raised-button color="primary"
                                    [disabled]="checkoutForm.invalid || isProcessing">
                                    <mat-icon>payment</mat-icon>
                                    <span *ngIf="!isProcessing">Đặt hàng</span>
                                    <span *ngIf="isProcessing">Đang xử lý...</span>
                                </button>
                            </div>
                        </form>
                    </mat-card-content>
                </mat-card>
            </div>
        </div>
    </div>
</div>